<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Dados Reais - Compara√ß√£o Site vs Edge Function</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .warning { background-color: #fff3cd; color: #856404; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .comparison-table th, .comparison-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .comparison-table th {
            background-color: #f2f2f2;
        }
        .difference {
            background-color: #ffebee;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Teste de Dados Reais - Compara√ß√£o Site vs Edge Function</h1>
        
        <div class="test-section">
            <h2>üìä Dados de Teste</h2>
            <p>Este teste usa dados reais de um assessment para comparar os resultados entre o site e a Edge Function.</p>
            <button onclick="runRealDataTest()">üöÄ Executar Teste com Dados Reais</button>
            <button onclick="testEdgeFunctionDirectly()">üåê Testar Edge Function Diretamente</button>
            <button onclick="clearResults()">üßπ Limpar Resultados</button>
        </div>
        
        <div id="results" class="test-section" style="display: none;">
            <h2>üìã Resultados da Compara√ß√£o</h2>
            <div id="comparison-results"></div>
        </div>
    </div>

    <script>
        // Dados reais de teste (baseados em um assessment t√≠pico)
        const realTestData = {
            userInfo: {
                name: "Jo√£o Silva",
                email: "joao.silva@empresa.com",
                company: "Empresa Teste Ltda",
                position: "Diretor",
                phone: "(11) 99999-9999"
            },
            answers: {
                q1: 3, q2: 4, q3: 2, q4: 3,  // Lideran√ßa
                q5: 3, q6: 2, q7: 4,         // Estrat√©gias e Planos
                q8: 2, q9: 3, q10: 3, q11: 4, q12: 2,  // Processos
                q13: 3, q14: 4, q15: 2, q16: 3, q17: 3, // Pessoas
                q18: 4, q19: 3, q20: 2, q21: 3,        // Clientes
                q22: 2, q23: 3, q24: 4, q25: 2,        // Resultados
                q26: 3, q27: 2, q28: 3,                // Sociedade
                q29: 4, q30: 3, q31: 2, q32: 3         // Informa√ß√µes e Conhecimento
            }
        };

        // Fun√ß√£o para calcular an√°lise de dimens√µes (copiada do site)
        function analyzeDimensionScores(answers) {
            const dimensionQuestions = {
                "Lideran√ßa": ["q1", "q2", "q3", "q4"],
                "Estrat√©gias e Planos": ["q5", "q6", "q7"],
                "Processos": ["q8", "q9", "q10", "q11", "q12"],
                "Pessoas": ["q13", "q14", "q15", "q16", "q17"],
                "Clientes": ["q18", "q19", "q20", "q21"],
                "Resultados": ["q22", "q23", "q24", "q25"],
                "Sociedade": ["q26", "q27", "q28"],
                "Informa√ß√µes e Conhecimento": ["q29", "q30", "q31", "q32"]
            };

            const dimensionAnalysis = {};

            Object.keys(dimensionQuestions).forEach(dimension => {
                const questions = dimensionQuestions[dimension];
                let totalScore = 0;
                let maxScore = questions.length * 5;

                questions.forEach(questionId => {
                    totalScore += answers[questionId] || 0;
                });

                const percentage = (totalScore / maxScore) * 100;
                const level = getDimensionLevel(percentage);

                dimensionAnalysis[dimension] = {
                    score: totalScore,
                    maxScore: maxScore,
                    percentage: percentage,
                    level: level
                };
            });

            return dimensionAnalysis;
        }

        // Fun√ß√£o getDimensionLevel (copiada do site)
        function getDimensionLevel(percentage) {
            if (percentage >= 90) {
                return {
                    level: 5,
                    title: "Excel√™ncia",
                    description: "Pr√°ticas de classe mundial, benchmarking para o setor, inova√ß√£o cont√≠nua e resultados excepcionais sustentados."
                };
            } else if (percentage >= 70) {
                return {
                    level: 4,
                    title: "Maturidade Avan√ßada",
                    description: "Pr√°ticas bem estabelecidas, resultados consistentes, melhoria cont√≠nua e abordagem sistem√°tica consolidada."
                };
            } else if (percentage >= 50) {
                return {
                    level: 3,
                    title: "Maturidade Intermedi√°ria",
                    description: "Pr√°ticas estruturadas implementadas, alguns resultados positivos, processos em desenvolvimento e melhorias identificadas."
                };
            } else if (percentage >= 30) {
                return {
                    level: 2,
                    title: "Desenvolvimento Inicial",
                    description: "Algumas pr√°ticas b√°sicas implementadas, resultados iniciais, processos em forma√ß√£o e oportunidades claras de melhoria."
                };
            } else {
                return {
                    level: 1,
                    title: "Est√°gio Inicial",
                    description: "Pr√°ticas limitadas ou inexistentes, resultados inconsistentes, necessidade urgente de estrutura√ß√£o e desenvolvimento."
                };
            }
        }

        // Fun√ß√£o getDimensionRecommendations (vers√£o simplificada para teste)
        function getDimensionRecommendations(dimension, level) {
            const recommendations = {
                "Lideran√ßa": {
                    1: "Estabelecer pr√°ticas b√°sicas de lideran√ßa e definir pap√©is e responsabilidades.",
                    2: "Desenvolver sistema de lideran√ßa mais estruturado com processos definidos.",
                    3: "Implementar pr√°ticas avan√ßadas de lideran√ßa e an√°lise cr√≠tica sistem√°tica.",
                    4: "Consolidar excel√™ncia em lideran√ßa e expandir pr√°ticas para toda organiza√ß√£o.",
                    5: "Manter lideran√ßa de classe mundial e servir como benchmark para o setor."
                },
                "Estrat√©gias e Planos": {
                    1: "Estabelecer processo b√°sico de planejamento estrat√©gico.",
                    2: "Formalizar metodologia de formula√ß√£o e implementa√ß√£o estrat√©gica.",
                    3: "Desenvolver capacidades avan√ßadas de an√°lise estrat√©gica e execu√ß√£o.",
                    4: "Consolidar excel√™ncia em gest√£o estrat√©gica e integra√ß√£o organizacional.",
                    5: "Manter pr√°ticas de classe mundial em estrat√©gia e inova√ß√£o cont√≠nua."
                }
                // Adicionar outras dimens√µes conforme necess√°rio
            };
            
            return recommendations[dimension]?.[level] || "Recomenda√ß√£o n√£o dispon√≠vel para esta dimens√£o e n√≠vel.";
        }

        async function runRealDataTest() {
            const resultsDiv = document.getElementById('results');
            const comparisonDiv = document.getElementById('comparison-results');
            
            resultsDiv.style.display = 'block';
            comparisonDiv.innerHTML = '<div class="info">üîÑ Executando teste com dados reais...</div>';

            try {
                // 1. Calcular an√°lise no "site" (local)
                const siteAnalysis = analyzeDimensionScores(realTestData.answers);
                
                // 2. Preparar dados para enviar √† Edge Function
                const edgeFunctionData = {
                    userInfo: realTestData.userInfo,
                    dimensionAnalysis: siteAnalysis,
                    totalScore: Object.values(siteAnalysis).reduce((sum, dim) => sum + dim.score, 0),
                    percentage: Object.values(siteAnalysis).reduce((sum, dim) => sum + dim.percentage, 0) / Object.keys(siteAnalysis).length
                };

                // 3. Testar Edge Function (simula√ß√£o local)
                const edgeResult = await testEdgeFunction(edgeFunctionData);
                
                // 4. Comparar resultados
                displayComparison(siteAnalysis, edgeResult, edgeFunctionData);
                
            } catch (error) {
                comparisonDiv.innerHTML = `<div class="error">‚ùå Erro durante o teste: ${error.message}</div>`;
            }
        }

        async function testEdgeFunction(data) {
            // Simular chamada √† Edge Function local
            try {
                const response = await fetch('http://localhost:54321/functions/v1/assessment-results', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error(`Edge Function retornou status ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Erro ao testar Edge Function:', error);
                return { error: error.message };
            }
        }

        function displayComparison(siteAnalysis, edgeResult, originalData) {
            const comparisonDiv = document.getElementById('comparison-results');
            
            let html = '<h3>üìä Resultados da Compara√ß√£o</h3>';
            
            // Verificar se houve erro na Edge Function
            if (edgeResult.error) {
                html += `<div class="error">‚ùå Erro na Edge Function: ${edgeResult.error}</div>`;
                html += '<div class="info">üí° Isso pode indicar que a Edge Function n√£o est√° rodando ou h√° problemas de conectividade.</div>';
            } else {
                html += '<div class="success">‚úÖ Edge Function respondeu com sucesso!</div>';
            }
            
            // Mostrar dados enviados
            html += '<h4>üì§ Dados Enviados para Edge Function:</h4>';
            html += '<table class="comparison-table">';
            html += '<tr><th>Dimens√£o</th><th>Pontua√ß√£o</th><th>Percentual</th><th>N√≠vel</th></tr>';
            
            Object.keys(siteAnalysis).forEach(dimension => {
                const analysis = siteAnalysis[dimension];
                html += `<tr>
                    <td>${dimension}</td>
                    <td>${analysis.score}/${analysis.maxScore}</td>
                    <td>${Math.round(analysis.percentage)}%</td>
                    <td>${analysis.level.level} - ${analysis.level.title}</td>
                </tr>`;
            });
            
            html += '</table>';
            
            // Mostrar resumo
            html += '<h4>üìà Resumo do Teste:</h4>';
            html += `<div class="info">
                <strong>Total de Dimens√µes:</strong> ${Object.keys(siteAnalysis).length}<br>
                <strong>Pontua√ß√£o Total:</strong> ${originalData.totalScore}<br>
                <strong>Percentual M√©dio:</strong> ${Math.round(originalData.percentage)}%
            </div>`;
            
            // Recomenda√ß√µes
            html += '<h4>üí° Pr√≥ximos Passos:</h4>';
            if (edgeResult.error) {
                html += `<div class="warning">
                    <strong>A√ß√£o Necess√°ria:</strong><br>
                    1. Verificar se a Edge Function est√° rodando (npx supabase functions serve)<br>
                    2. Verificar se n√£o h√° erros no console da Edge Function<br>
                    3. Testar com dados mais simples para isolar o problema
                </div>`;
            } else {
                html += `<div class="success">
                    <strong>Teste Bem-sucedido:</strong><br>
                    1. A comunica√ß√£o com a Edge Function est√° funcionando<br>
                    2. Os dados est√£o sendo processados corretamente<br>
                    3. Verificar se o email foi enviado com as recomenda√ß√µes corretas
                </div>`;
            }
            
            comparisonDiv.innerHTML = html;
        }

        async function testEdgeFunctionDirectly() {
            const comparisonDiv = document.getElementById('comparison-results');
            const resultsDiv = document.getElementById('results');
            
            resultsDiv.style.display = 'block';
            comparisonDiv.innerHTML = '<div class="info">üîÑ Testando conectividade com Edge Function...</div>';
            
            try {
                const response = await fetch('http://localhost:54321/functions/v1/assessment-results', {
                    method: 'OPTIONS'
                });
                
                if (response.ok) {
                    comparisonDiv.innerHTML = '<div class="success">‚úÖ Edge Function est√° respondendo! Conectividade OK.</div>';
                } else {
                    comparisonDiv.innerHTML = `<div class="error">‚ùå Edge Function retornou status ${response.status}</div>`;
                }
            } catch (error) {
                comparisonDiv.innerHTML = `<div class="error">‚ùå N√£o foi poss√≠vel conectar √† Edge Function: ${error.message}<br><br>üí° Verifique se a Edge Function est√° rodando com: <code>npx supabase functions serve assessment-results</code></div>`;
            }
        }

        function clearResults() {
            document.getElementById('results').style.display = 'none';
            document.getElementById('comparison-results').innerHTML = '';
        }
    </script>
</body>
</html>