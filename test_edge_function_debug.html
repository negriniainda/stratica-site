<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Edge Function - Teste de Recomenda√ß√µes</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .warning { background-color: #fff3cd; color: #856404; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .json-display {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .dimension-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Debug Edge Function - Teste de Recomenda√ß√µes</h1>
        
        <div class="test-section">
            <h2>üéØ Objetivo</h2>
            <p>Este teste envia dados espec√≠ficos para a Edge Function e analisa detalhadamente as recomenda√ß√µes retornadas para identificar poss√≠veis diverg√™ncias.</p>
            
            <button onclick="testSpecificCase()">üöÄ Testar Caso Espec√≠fico</button>
            <button onclick="testMultipleCases()">üìä Testar M√∫ltiplos Casos</button>
            <button onclick="clearResults()">üßπ Limpar Resultados</button>
        </div>
        
        <div id="results" class="test-section" style="display: none;">
            <h2>üìã Resultados do Teste</h2>
            <div id="test-results"></div>
        </div>
    </div>

    <script>
        // Casos de teste espec√≠ficos
        const testCases = [
            {
                name: "Caso 1 - Lideran√ßa Baixa",
                userInfo: {
                    name: "Teste Usuario 1",
                    email: "teste1@empresa.com",
                    company: "Empresa Teste",
                    position: "Gerente",
                    phone: "(11) 99999-9999"
                },
                dimensionAnalysis: {
                    "Lideran√ßa": {
                        score: 8,
                        maxScore: 20,
                        percentage: 40,
                        level: {
                            level: 2,
                            title: "Desenvolvimento Inicial",
                            description: "Algumas pr√°ticas b√°sicas implementadas, resultados iniciais, processos em forma√ß√£o e oportunidades claras de melhoria."
                        }
                    },
                    "Estrat√©gias e Planos": {
                        score: 12,
                        maxScore: 15,
                        percentage: 80,
                        level: {
                            level: 4,
                            title: "Maturidade Avan√ßada",
                            description: "Pr√°ticas bem estabelecidas, resultados consistentes, melhoria cont√≠nua e abordagem sistem√°tica consolidada."
                        }
                    }
                }
            },
            {
                name: "Caso 2 - Todas Dimens√µes M√©dias",
                userInfo: {
                    name: "Teste Usuario 2",
                    email: "teste2@empresa.com",
                    company: "Empresa Teste 2",
                    position: "Diretor",
                    phone: "(11) 88888-8888"
                },
                dimensionAnalysis: {
                    "Lideran√ßa": {
                        score: 12,
                        maxScore: 20,
                        percentage: 60,
                        level: {
                            level: 3,
                            title: "Maturidade Intermedi√°ria",
                            description: "Pr√°ticas estruturadas implementadas, alguns resultados positivos, processos em desenvolvimento e melhorias identificadas."
                        }
                    },
                    "Estrat√©gias e Planos": {
                        score: 9,
                        maxScore: 15,
                        percentage: 60,
                        level: {
                            level: 3,
                            title: "Maturidade Intermedi√°ria",
                            description: "Pr√°ticas estruturadas implementadas, alguns resultados positivos, processos em desenvolvimento e melhorias identificadas."
                        }
                    },
                    "Processos": {
                        score: 15,
                        maxScore: 25,
                        percentage: 60,
                        level: {
                            level: 3,
                            title: "Maturidade Intermedi√°ria",
                            description: "Pr√°ticas estruturadas implementadas, alguns resultados positivos, processos em desenvolvimento e melhorias identificadas."
                        }
                    }
                }
            }
        ];

        async function testSpecificCase() {
            const resultsDiv = document.getElementById('results');
            const testResultsDiv = document.getElementById('test-results');
            
            resultsDiv.style.display = 'block';
            testResultsDiv.innerHTML = '<div class="info">üîÑ Executando teste espec√≠fico...</div>';

            try {
                const testCase = testCases[0]; // Usar o primeiro caso
                
                // Calcular dados adicionais
                const totalScore = Object.values(testCase.dimensionAnalysis).reduce((sum, dim) => sum + dim.score, 0);
                const avgPercentage = Object.values(testCase.dimensionAnalysis).reduce((sum, dim) => sum + dim.percentage, 0) / Object.keys(testCase.dimensionAnalysis).length;
                
                const requestData = {
                    userInfo: testCase.userInfo,
                    dimensionAnalysis: testCase.dimensionAnalysis,
                    totalScore: totalScore,
                    percentage: avgPercentage
                };

                console.log('Enviando dados para Edge Function:', requestData);
                
                // Enviar para Edge Function
                const response = await fetch('http://localhost:54321/functions/v1/assessment-results', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0'
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    throw new Error(`Edge Function retornou status ${response.status}: ${await response.text()}`);
                }
                
                const result = await response.json();
                console.log('Resposta da Edge Function:', result);
                
                displayTestResult(testCase, requestData, result);
                
            } catch (error) {
                console.error('Erro no teste:', error);
                testResultsDiv.innerHTML = `<div class="error">‚ùå Erro durante o teste: ${error.message}</div>`;
            }
        }

        async function testMultipleCases() {
            const resultsDiv = document.getElementById('results');
            const testResultsDiv = document.getElementById('test-results');
            
            resultsDiv.style.display = 'block';
            testResultsDiv.innerHTML = '<div class="info">üîÑ Executando m√∫ltiplos casos de teste...</div>';

            let html = '<h3>üìä Resultados de M√∫ltiplos Testes</h3>';
            
            for (let i = 0; i < testCases.length; i++) {
                const testCase = testCases[i];
                
                try {
                    html += `<h4>üß™ ${testCase.name}</h4>`;
                    
                    // Calcular dados adicionais
                    const totalScore = Object.values(testCase.dimensionAnalysis).reduce((sum, dim) => sum + dim.score, 0);
                    const avgPercentage = Object.values(testCase.dimensionAnalysis).reduce((sum, dim) => sum + dim.percentage, 0) / Object.keys(testCase.dimensionAnalysis).length;
                    
                    const requestData = {
                        userInfo: testCase.userInfo,
                        dimensionAnalysis: testCase.dimensionAnalysis,
                        totalScore: totalScore,
                        percentage: avgPercentage
                    };

                    // Enviar para Edge Function
                    const response = await fetch('http://localhost:54321/functions/v1/assessment-results', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0'
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        html += `<div class="success">‚úÖ Teste executado com sucesso! Email ID: ${result.id || 'N/A'}</div>`;
                        
                        // Mostrar resumo das dimens√µes testadas
                        html += '<div class="info"><strong>Dimens√µes testadas:</strong><br>';
                        Object.keys(testCase.dimensionAnalysis).forEach(dimension => {
                            const analysis = testCase.dimensionAnalysis[dimension];
                            html += `‚Ä¢ ${dimension}: ${analysis.percentage}% (N√≠vel ${analysis.level.level})<br>`;
                        });
                        html += '</div>';
                    } else {
                        html += `<div class="error">‚ùå Erro: Status ${response.status}</div>`;
                    }
                    
                } catch (error) {
                    html += `<div class="error">‚ùå Erro no teste ${testCase.name}: ${error.message}</div>`;
                }
                
                // Pequena pausa entre testes
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            html += '<div class="success">üéâ Todos os testes conclu√≠dos! Verifique os logs da Edge Function para mais detalhes.</div>';
            testResultsDiv.innerHTML = html;
        }

        function displayTestResult(testCase, requestData, result) {
            const testResultsDiv = document.getElementById('test-results');
            
            let html = `<h3>üß™ Resultado do Teste: ${testCase.name}</h3>`;
            
            // Status do teste
            if (result.id) {
                html += `<div class="success">‚úÖ Teste executado com sucesso!<br><strong>Email ID:</strong> ${result.id}</div>`;
            } else {
                html += '<div class="warning">‚ö†Ô∏è Teste executado, mas sem ID de email retornado.</div>';
            }
            
            // Dados enviados
            html += '<div class="comparison-grid">';
            html += '<div class="dimension-card">';
            html += '<h4>üì§ Dados Enviados</h4>';
            html += `<div class="json-display">${JSON.stringify(requestData, null, 2)}</div>`;
            html += '</div>';
            
            // Resposta recebida
            html += '<div class="dimension-card">';
            html += '<h4>üì• Resposta Recebida</h4>';
            html += `<div class="json-display">${JSON.stringify(result, null, 2)}</div>`;
            html += '</div>';
            html += '</div>';
            
            // An√°lise das dimens√µes
            html += '<h4>üìä An√°lise das Dimens√µes Testadas</h4>';
            Object.keys(testCase.dimensionAnalysis).forEach(dimension => {
                const analysis = testCase.dimensionAnalysis[dimension];
                html += `<div class="dimension-card">
                    <strong>${dimension}</strong><br>
                    Pontua√ß√£o: ${analysis.score}/${analysis.maxScore} (${analysis.percentage}%)<br>
                    N√≠vel: ${analysis.level.level} - ${analysis.level.title}<br>
                    <small>${analysis.level.description}</small>
                </div>`;
            });
            
            // Instru√ß√µes para verifica√ß√£o
            html += '<div class="info">';
            html += '<h4>üîç Pr√≥ximos Passos para Verifica√ß√£o:</h4>';
            html += '<ol>';
            html += '<li>Verificar se o email foi enviado para: <strong>' + testCase.userInfo.email + '</strong></li>';
            html += '<li>Conferir se as recomenda√ß√µes no email correspondem aos n√≠veis calculados</li>';
            html += '<li>Comparar com as recomenda√ß√µes que seriam geradas pelo site</li>';
            html += '<li>Verificar os logs da Edge Function no terminal para detalhes do processamento</li>';
            html += '</ol>';
            html += '</div>';
            
            testResultsDiv.innerHTML = html;
        }

        function clearResults() {
            document.getElementById('results').style.display = 'none';
            document.getElementById('test-results').innerHTML = '';
        }
    </script>
</body>
</html>